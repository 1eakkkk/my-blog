// --- functions/api/draw.js (带记忆功能版) ---

// === 1. 64卦数据库 (Key: 初爻->上爻, 1=阳, 0=阴) ===
// 内容依据《周易》原文及传统解卦，包含运势与处世建议。
const HEXAGRAMS = {
    "111111": { name: "乾为天", title: "乾", desc: "元亨利贞。大吉之象，如龙飞天，刚健中正。您的能量正处于巅峰，事业与运势如日中天。但切记‘亢龙有悔’，忌傲慢强横，宜自强不息，刚柔并济。" },
    "000000": { name: "坤为地", title: "坤", desc: "厚德载物。元亨，利牝马之贞。形势利于柔顺伸展，不宜主动领头，而应配合他人。先迷后得，以包容之心待人接物，利西南，不利东北。" },
    "100010": { name: "水雷屯", title: "屯", desc: "万物始生，破土之难。象义为‘屯’，积蓄力量。目前虽有阻滞，处于创业或起步的艰难期，但前景光明。切勿轻举妄动，宜建侯，广结善缘，耐心破局。" },
    "010001": { name: "山水蒙", title: "蒙", desc: "蒙昧初开，需待启蒙。当前局势不明朗，自身经验不足。利用刑人，御说桎梏。宜诚心求教于明师，切忌自作聪明。时机未到，暂缓行动。" },
    "111010": { name: "水天需", title: "需", desc: "云在天上，需待时机。有险在前，不宜冒进。君子以饮食宴乐，此时应积蓄力量，耐心等待。利涉大川，待时机成熟自然水到渠成。" },
    "010111": { name: "天水讼", title: "讼", desc: "身陷争执，事与愿违。上刚下险，易生口舌是非。虽有利可图但难以持久。君子以作事谋始，宜止争，退一步海阔天空，不宜涉险或打官司。" },
    "010000": { name: "地水师", title: "师", desc: "行军用师，严正以律。此时需要强有力的领导或纪律。贞，丈人吉，无咎。若行事散漫则必凶。适合整顿团队，统筹规划，以正道行事。" },
    "000010": { name: "水地比", title: "比", desc: "亲密比辅，众星拱月。地上有水，相依相存。运势吉利，利于合作、交友、建交。原筮元永贞，无咎。只要以诚待人，必有贵人相助。" },
    "111011": { name: "风天小畜", title: "小畜", desc: "密云不雨，力量有限。阳多阴少，尚不足以成大事。君子以懿文德，此时宜韬光养晦，积蓄微小的力量，处理细节，不宜图谋大业。" },
    "110111": { name: "天泽履", title: "履", desc: "如履薄冰，伴君如伴虎。虽面临危险（踩在老虎尾巴上），但只要行事小心谨慎，依礼而行，终究有惊无险。大吉，利于在体制内或险境中生存。" },
    "111000": { name: "地天泰", title: "泰", desc: "天地交泰，万物通畅。小往大来，吉亨。阴阳调和，上下同心。这是极好的卦象，诸事顺遂，适合开展新计划，但需防‘城复于隍’，居安思危。" },
    "000111": { name: "天地否", title: "否", desc: "天地不交，万物不通。大往小来，不利君子贞。上下隔阂，小人道长，君子道消。此时宜收敛锋芒，退避三舍，不可同流合污，静待时变。" },
    "101111": { name: "天火同人", title: "同人", desc: "与人同心，其利断金。天与火同人，君子以类族辨物。利涉大川，利君子贞。非常利于团队合作、社交公关。打破私心，公平公正，则大事可成。" },
    "111101": { name: "火天大有", title: "大有", desc: "日丽中天，盛大丰有。火在天上，光普照万物。元亨。运势极佳，资源富足，众人归附。但需遏恶扬善，顺天休命，切忌挥霍浪费或仗势欺人。" },
    "001000": { name: "地山谦", title: "谦", desc: "内高外低，谦谦君子。地中有山，深藏不露。亨，君子有终。这是六十四卦中唯一全吉的卦。无论处于何种地位，保持谦虚低调，都会得到善果。" },
    "000100": { name: "雷地豫", title: "豫", desc: "雷出地奋，安乐愉悦。利建侯行师。运势顺畅，心情舒畅，利于兴办事业。但也暗示容易沉溺享乐，需防乐极生悲，不可懈怠。" },
    "100110": { name: "泽雷随", title: "随", desc: "随顺时势，随机应变。泽中有雷，君子以向晦入宴息。元亨利贞，无咎。不要固执己见，顺应客观规律和他人意见，随遇而安，反而能成事。" },
    "011001": { name: "山风蛊", title: "蛊", desc: "器皿生虫，亟待整顿。物腐虫生，积弊已久。利涉大川，先甲三日，后甲三日。此时必须大刀阔斧地改革，清理旧患，虽过程痛苦，但结果吉利。" },
    "110000": { name: "地泽临", title: "临", desc: "居高临下，监临统御。地利人和，正是大展宏图之时。元亨利贞，至于八月有凶。好运当前，宜积极推进，但需警惕好景不长，要在盛时为衰时做准备。" },
    "000011": { name: "风地观", title: "观", desc: "风行地上，观摩省察。盥而不荐，有孚颙若。此时宜静不宜动，多观察，多思考，展示自己的威仪而不轻举妄动，以赢得他人的信赖。" },
    "100101": { name: "火雷噬嗑", title: "噬嗑", desc: "咬合咀嚼，铲除梗阻。口中有物，必须咬断。利用狱。当前面临阻碍或小人，必须采取强硬手段，明辨是非，恩威并施，才能亨通。" },
    "101001": { name: "山火贲", title: "贲", desc: "文饰光彩，外表修饰。山下有火，明亮美丽。小利有攸往。利于艺术、设计、社交等需要展示形象的事物。但也需注意不可徒有其表，要文质彬彬。" },
    "000001": { name: "山地剥", title: "剥", desc: "剥落侵蚀，群阴剥阳。山附于地，基础动摇。不利有攸往。当前形势险恶，小人得势，不宜有所作为。唯一能做的是顺势而止，保护硕果仅存的阳气。" },
    "100000": { name: "地雷复", title: "复", desc: "一阳来复，万物更生。雷在地中，生机萌发。出入无疾，朋来无咎。黑暗过去，光明初现。虽然力量尚小，但趋势向好，宜休养生息，徐图发展。" },
    "100111": { name: "天雷无妄", title: "无妄", desc: "真实无妄，顺其自然。天下雷行，物与无妄。元亨利贞，其匪正有眚。行事必须心存正念，不可有非分之想。若动机不纯，必有灾祸。守正即吉。" },
    "111001": { name: "山天大畜", title: "大畜", desc: "积蓄巨大，德智充实。天在山中，蕴藏深厚。利涉大川，应天顺人。既要积蓄财力学识，又要适时止健。时机成熟时，可担大任，行大事。" },
    "100001": { name: "山雷颐", title: "颐", desc: "观颐，自求口实。山下有雷，动静不失其时。重点在于‘养’。慎言语（祸从口出），节饮食（病从口入）。既要修身养性，也要颐养贤才。" },
    "011110": { name: "泽风大过", title: "大过", desc: "栋桡，本末俱弱。泽灭木，压力过大，难以支撑。非常时期，当行非常之事。利有攸往，亨。虽然负担沉重，但若能刚柔并济，独立不惧，亦可成事。" },
    "010010": { name: "坎为水", title: "坎", desc: "重重险陷，进退两难。水流而不盈，行险而有信。维心亨，乃以刚中也。当前处境艰难，如临深渊。切勿惊慌失措，唯有信心与诚信可渡难关。" },
    "101101": { name: "离为火", title: "离", desc: "光明附丽，柔顺中正。明两作离，大人以继明照于四方。利贞，亨。畜牝牛吉。需要依附于正道或有能力的人。保持内心的柔顺与光明，可获吉。" },
    "001110": { name: "泽山咸", title: "咸", desc: "感应相通，男女相悦。山上有泽，虚怀若谷。亨，利贞，取女吉。这是关于感情与感应的卦。利于恋爱、结婚、沟通。心诚则灵，无心之感最为灵验。" },
    "011100": { name: "雷风恒", title: "恒", desc: "恒久不已，持之以恒。雷风相与，君子以立不易方。亨，无咎，利贞。利有攸往。无论是感情还是事业，都要坚持初衷，有恒心者事竟成。忌朝三暮四。" },
    "001111": { name: "天山遁", title: "遁", desc: "退避隐遁，远离小人。天下有山，君子以远小人，不恶而严。小利贞。当前形势不利，宜退不宜进。急流勇退是智慧，明哲保身，等待时机。" },
    "111100": { name: "雷天大壮", title: "大壮", desc: "雷在天上，刚壮有力。君子以非礼弗履。利贞。运势强盛，但不可恃强妄为。就像公羊撞篱笆，用力过猛反而会被困住。需守正道，适可而止。" },
    "000101": { name: "火地晋", title: "晋", desc: "旭日东升，步步高升。明出地上，君子以自昭明德。康侯用锡马蕃庶，昼日三接。运势如日初升，利于求官、求名、晋升。得到上司赏识，前途无量。" },
    "101000": { name: "地火明夷", title: "明夷", desc: "光明受损，晦暗不明。明入地中，君子以莅众，用晦而明。利艰贞。环境黑暗，贤人受压。此时应韬光养晦，隐藏智慧，甚至装傻充愣，以求自保。" },
    "101011": { name: "风火家人", title: "家人", desc: "入内理家，各正其位。风自火出，君子以言有物，而行有恒。利女贞。重点在于家庭和团队内部的治理。家和万事兴，内部团结，外部自然顺遂。" },
    "110101": { name: "火泽睽", title: "睽", desc: "二女同居，其志不同。上火下泽，背道而驰。小事吉。人际关系出现裂痕，意见不合，反目成仇。大事难成，只能做些小事。宜求同存异。" },
    "001010": { name: "水山蹇", title: "蹇", desc: "前路险阻，寸步难行。山高水深，君子以反身修德。利西南，不利东北。利见大人。此时不宜强行前进，应停下来反省自己，寻求贵人帮助，等待时机。" },
    "010100": { name: "雷水解", title: "解", desc: "险难化解，万物复苏。雷雨作，君子以赦过宥罪。无所往，其来复吉。困难时期已经过去，宜宽容待人，从简行事，休养生息，不要多生枝节。" },
    "110001": { name: "山泽损", title: "损", desc: "减损当前，以益未来。损下益上，其道上行。有孚，元吉，无咎。为了长远利益，可能需要暂时的牺牲或投入。诚心诚意，哪怕祭品微薄也能得到保佑。" },
    "100011": { name: "风雷益", title: "益", desc: "损上益下，大有裨益。风雷激荡，君子以见善则迁，有过则改。利有攸往，利涉大川。运势极佳，利于施惠于人，改正错误。付出越多，收获越大。" },
    "111110": { name: "泽天夬", title: "夬", desc: "决断清除，刚决柔也。扬于王庭，孚号有厉。必须公开地、果断地清除小人或积弊。但这需要极大的勇气和智慧，切忌动用暴力，要正大光明。" },
    "011111": { name: "天风姤", title: "姤", desc: "阴阳相遇，风云际会。天下有风，后以施命诰四方。女壮，勿用取女。这是一种不期而遇的缘分，但这种缘分往往短暂或不正。利于发布命令，不利于长久结合。" },
    "000110": { name: "泽地萃", title: "萃", desc: "群英荟萃，万物聚集。泽上于地，君子以除戎器，戒不虞。亨，王假有庙。利于团聚、集资、开会。但也容易鱼龙混杂，需修整兵器，防备意外。" },
    "011000": { name: "地风升", title: "升", desc: "积小成大，顺势上升。地中生木，君子以顺德，积小以高大。元亨，用见大人，勿恤。像树木生长一样，稳步上升。利于晋升，只要持之以恒，终成大器。" },
    "010110": { name: "泽水困", title: "困", desc: "泽无水，困守愁城。致命的干涸。亨，贞，大人吉，无咎。有言不信。身处困境，才华无法施展。此时说什么都没人信，唯有修身养性，坚守节操，静待水来。" },
    "011010": { name: "水风井", title: "井", desc: "养人而不穷，改邑不改井。木上有水，君子以劳民劝相。往来井井，求贤若渴。资源（如井水）就在那里，关键在于如何修缮和挖掘。利于培养人才，共享资源。" },
    "101110": { name: "泽火革", title: "革", desc: "顺天应人，变革更新。泽中有火，君子以治历明时。已日乃孚，元亨利贞，悔亡。旧的事物已腐朽，必须彻底变革。时机成熟时（已日），大胆改革必获信任。" },
    "011101": { name: "火风鼎", title: "鼎", desc: "稳重图变，去旧取新。木上有火，君子以正位凝命。元吉，亨。鼎是重器，象征权力与合作。利于建立新秩序，三人成众，合伙谋事，大吉大利。" },
    "100100": { name: "震为雷", title: "震", desc: "震惊百里，临危不乱。荐雷，君子以恐惧修省。亨，笑言哑哑。突发事变，众人恐慌，唯有君子能泰然处之，甚至谈笑风生。危机就是转机，通过震动来反省自己。" },
    "001001": { name: "艮为山", title: "艮", desc: "动静适时，该止则止。兼山，君子以思不出其位。艮其背，不获其身。时行则行，时止则止。当前宜静止不动，不要越位，不要强求。控制欲望，回归内心。" },
    "001011": { name: "风山渐", title: "渐", desc: "循序渐进，积少成多。山上有木，君子以居贤德善俗。女归吉，利贞。像鸿雁飞翔一样有序，像树木生长一样缓慢。切忌急躁，慢慢来，一切都会好起来。" },
    "110100": { name: "雷泽归妹", title: "归妹", desc: "违背常理，动之不当。泽上有雷，君子以永终知敝。征凶，无攸利。过程可能很愉快（如少女急着出嫁），但结果往往不幸。名不正言不顺，长久来看会有凶险。" },
    "101100": { name: "雷火丰", title: "丰", desc: "丰大光明，如日中天。雷电皆至，君子以折狱致刑。亨，王假之。运势达到顶峰，盛大丰满。但也意味着即将衰落（日中则昃）。宜果断行动，此时最适合断案决狱。" },
    "001101": { name: "火山旅", title: "旅", desc: "行旅在外，不安定之象。山上有火，君子以明慎用刑，而不留狱。小亨，旅贞吉。处于变动之中，如旅行者。宜守正，不宜过分强硬。虽然不稳定，但若能谨慎，小事可成。" },
    "011011": { name: "巽为风", title: "巽", desc: "柔顺谦逊，无孔不入。随风，君子以申命行事。小亨，利有攸往，利见大人。像风一样顺从、渗透。此时不宜强攻，宜通过沟通、反复申述来实现目标。" },
    "110110": { name: "兑为泽", title: "兑", desc: "喜悦沟通，朋友讲习。丽泽，君子以朋友讲习。亨，利贞。两泽相连，互相滋益。利于交流、演讲、谈判。保持喜悦的心情，能感染他人，诸事顺遂。" },
    "010011": { name: "风水涣", title: "涣", desc: "冰雪消融，排难解纷。风行水上，先王以享于帝立庙。亨，王假有庙，利涉大川。人心离散（涣散）之时，需要通过信仰或共同目标来凝聚人心。利于冒险犯难，解决问题。" },
    "110010": { name: "水泽节", title: "节", desc: "节制有度，适可而止。泽上有水，君子以制数度，议德行。亨，苦节不可贞。资源有限，必须节约；行为放纵，必须节制。但节制不可太过（苦节），否则无法持久。" },
    "110011": { name: "风泽中孚", title: "中孚", desc: "诚信立身，心诚则灵。泽上有风，君子以议狱缓死。豚鱼吉，利涉大川。诚信能感动猪鱼等微物。只要心存诚信，即使涉大川历大险也能化险为夷。" },
    "001100": { name: "雷山小过", title: "小过", desc: "小有过度，宜下不宜上。山上有雷，君子以行过乎恭，丧过乎哀，用过乎俭。亨，利贞。大得飞鸟之象。此时不宜做大事，只宜做小事。稍微过度一点（如过分谦恭）是好的。" },
    "101010": { name: "水火既济", title: "既济", desc: "万事已成，完美的结局。水在火上，君子以思患而预防之。亨小，利贞，初吉终乱。阴阳各得其位，事情已经成功。但物极必反，盛极必衰，需防患于未然。" },
    "010101": { name: "火水未济", title: "未济", desc: "未完成，充满希望。火在水上，君子以慎辨物居方。亨，小狐汔济，濡其尾。阴阳失位，事情尚未成功。但这正是新循环的开始，充满无限可能。需慎终如始。" }
};

// ... addXpWithCap, tossCoins 辅助函数保持不变 ...
async function addXpWithCap(db, userId, amount, today) {
  const user = await db.prepare('SELECT daily_xp, last_xp_date FROM users WHERE id = ?').bind(userId).first();
  let currentDailyXp = (user.last_xp_date === today) ? (user.daily_xp || 0) : 0;
  if (currentDailyXp >= 120) { await db.prepare('UPDATE users SET last_xp_date = ? WHERE id = ?').bind(today, userId).run(); return { added: 0, msg: '今日经验已满' }; }
  let actualAdd = amount;
  if (currentDailyXp + amount > 120) actualAdd = 120 - currentDailyXp;
  await db.prepare('UPDATE users SET xp = xp + ?, daily_xp = ?, last_xp_date = ? WHERE id = ?').bind(actualAdd, currentDailyXp + actualAdd, today, userId).run();
  return { added: actualAdd, msg: `经验 +${actualAdd}` };
}

function tossCoins() {
    const sum = (Math.random()>0.5?3:2) + (Math.random()>0.5?3:2) + (Math.random()>0.5?3:2);
    return { val: sum, isYang: (sum % 2 !== 0) ? 1 : 0 };
}

export async function onRequestPost(context) {
  const db = context.env.DB;
  const cookie = context.request.headers.get('Cookie');
  
  if (!cookie) return new Response(JSON.stringify({ success: false }), { status: 401 });
  const sessionId = cookie.match(/session_id=([^;]+)/)?.[1];
  const user = await db.prepare(`SELECT * FROM sessions JOIN users ON sessions.user_id = users.id WHERE sessions.session_id = ?`).bind(sessionId).first();
  if (!user) return new Response(JSON.stringify({ success: false, error: '无效会话' }));

  const now = Date.now();
  const utc8 = new Date(now + (8 * 60 * 60 * 1000));
  const today = utc8.toISOString().split('T')[0];

  const requestBody = await context.request.json().catch(() => ({}));
  // 前端传入 action='check' 用于查询状态
  const isCheck = requestBody.action === 'check';

  // === 1. 检查今日是否已抽 (包含 Check 逻辑) ===
  if (user.last_draw === today) {
      // 核心修改：如果已抽，不报错，而是返回存储的卦象
      const savedCode = user.daily_hexagram_code;
      if (savedCode && HEXAGRAMS[savedCode]) {
          // 把 code 字符串 "101010" 转回数组 [1,0,1,0,1,0]
          const lines = savedCode.split('').map(Number);
          
          return new Response(JSON.stringify({ 
              success: true, 
              played: true, // 标记已玩过
              lines: lines,
              result: HEXAGRAMS[savedCode],
              message: "今日卦象已定，宜顺势而为。"
          }));
      }
  }

  // 如果只是 check 状态，且没抽过，则返回未抽
  if (isCheck) {
      return new Response(JSON.stringify({ success: true, played: false }));
  }

  // === 2. 执行新抽奖 ===
  if (user.status === 'banned') return new Response(JSON.stringify({ success: false, error: '封禁中' }));

  let binaryCode = "";
  let lines = [];
  for (let i = 0; i < 6; i++) {
      const toss = tossCoins();
      binaryCode += toss.isYang; 
      lines.push(toss.isYang);   
  }

  const hexagram = HEXAGRAMS[binaryCode] || { name: "数据溢出", title: "??", desc: "矩阵波动。" };
  const xpResult = await addXpWithCap(db, user.id, 50, today);
  const coinReward = Math.floor(Math.random() * 20) + 10;

  // 存入 daily_hexagram_code
  await db.batch([
      db.prepare('UPDATE users SET last_draw = ?, daily_hexagram_code = ?, coins = coins + ? WHERE id = ?')
        .bind(today, binaryCode, coinReward, user.id)
  ]);

  return new Response(JSON.stringify({ 
      success: true, 
      played: false, // 标记这是新抽的
      lines: lines,
      result: hexagram,
      message: `卦象已成。(${xpResult.msg}, i币 +${coinReward})`
  }));
}
